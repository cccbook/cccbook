### **9.4 Beam Search 與 Top-k 生成方法**

在生成式語言模型中，生成策略對最終的預測結果有著重要影響。兩種常見的生成策略是 **Beam Search** 和 **Top-k 生成方法**。這些方法通過不同的策略選擇生成過程中的最優輸出，從而改善模型的生成質量和多樣性。

#### **9.4.1 Beam Search 基本原理**

Beam Search 是一種在語言生成過程中平衡解的多樣性和準確性的方法。它是基於貪婪算法（Greedy Algorithm），但與貪婪算法不同的是，Beam Search 在每一步選擇多個候選，而不是只選擇概率最大的單一選項。

**Beam Search** 主要的特點在於，它保留了多個候選序列，這些候選序列的數量由 **beam width**（束寬度）決定。在每一個生成步驟中，Beam Search 會計算所有可能的詞語，並從這些詞語中選擇概率較高的詞語進行生成，最終返回擁有最高總概率的序列。

Beam Search 的步驟如下：

1. **初始化**：將起始狀態作為序列的初始候選，通常是語言模型中的 `<START>` 標記。
2. **生成過程**：對於當前序列的每一個候選，計算接下來可能生成的所有詞語的概率。這樣，對於每一個候選，會生成一個新的候選集。
3. **篩選候選**：根據設置的 **beam width**，從當前所有候選中選擇概率最高的前 `beam width` 個候選。
4. **終止條件**：重複這一過程直到達到預設的終止條件（如生成 `<END>` 標記，或達到最大生成長度）。

#### **9.4.2 Beam Search 的數學表示**

設 \( y = (y_1, y_2, \dots, y_t) \) 是模型生成的詞序列，\( y_t \) 是在時間步 \( t \) 生成的詞語。假設有一個序列模型，其目的是最大化生成序列的條件概率 \( P(y | x) \)，其中 \( x \) 是給定的上下文。對於每一個時間步 \( t \)，Beam Search 會計算對所有詞語 \( y_t \) 的概率分佈：

\[
P(y_t | y_{1:t-1}, x)
\]

然後，將這些概率最高的 \( beam\_width \) 個候選序列選擇出來，並作為下一步生成的基礎。這樣，Beam Search 會在每一步保留多個最有可能的序列，並逐步生成最終序列。

#### **9.4.3 Top-k 生成方法**

與 Beam Search 相比，**Top-k 生成方法** 是一種更為簡單的策略。在每一個生成步驟中，Top-k 方法只保留前 \( k \) 個最有可能的候選，然後從中隨機選擇一個詞語來繼續生成。這種方法的優點是可以引入隨機性，從而增加生成結果的多樣性，避免模型過於保守。

**Top-k 生成方法** 的步驟如下：

1. **初始化**：從語言模型的 `<START>` 標記開始。
2. **生成過程**：在每一步生成過程中，計算所有可能的下一個詞語的概率分佈 \( P(y_t | y_{1:t-1}, x) \)。
3. **篩選候選**：選擇概率最高的前 \( k \) 個詞語，並在這些候選中隨機選擇一個詞語作為下一步的生成詞。
4. **終止條件**：重複步驟 2 和 3 直到達到預設的終止條件。

#### **9.4.4 Top-k 與 Beam Search 的比較**

- **Beam Search** 是一個確定性方法，它會保證返回概率最大的序列。它適合於對生成質量有較高要求的任務，並且在大多數情況下會比 Top-k 方法產生更具語法和語義合理性的結果。然而，Beam Search 有可能會陷入局部最優解，導致多樣性不足。
  
- **Top-k 方法** 引入了隨機性，從而使得生成結果更加多樣。它適合於生成任務中需要創造性或多樣性的情境，如故事生成或詩歌創作。然而，過小的 \( k \) 值可能導致生成結果過於隨機，並且缺乏語法和語義的連貫性。

#### **9.4.5 Top-p (Nucleus) Sampling**

除了 Beam Search 和 Top-k 方法，還有一種改進的生成策略叫做 **Top-p (Nucleus) Sampling**。這種方法在生成過程中選擇具有累積概率大於等於 \( p \) 的詞語集合，而不是簡單地選擇概率最大的前 \( k \) 個詞語。這樣能夠保留更多的多樣性，同時避免低概率的詞語過多影響結果。

#### **9.4.6 結論**

Beam Search 和 Top-k 生成方法是常見的語言生成策略。Beam Search 更加注重生成序列的準確性，保證選擇的序列具有較高的條件概率，而 Top-k 則更強調隨機性和多樣性。根據應用需求，選擇合適的生成方法對於提升模型的效果至關重要。
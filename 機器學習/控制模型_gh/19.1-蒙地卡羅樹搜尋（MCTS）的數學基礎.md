### 19.1 蒙地卡羅樹搜尋（MCTS）的數學基礎

蒙地卡羅樹搜尋（Monte Carlo Tree Search, MCTS）是一種基於隨機模擬的強大搜尋方法，常用於解決大型決策問題，尤其在具有複雜狀態空間的博弈和控制領域中得到廣泛應用。MCTS的核心思想是通過隨機模擬來估算每一個可能行動的效果，並逐步改進決策過程。它尤其在遊戲領域（如圍棋、國際象棋）和強化學習中扮演了至關重要的角色。

MCTS的數學基礎涉及到樹搜索、隨機性模擬以及從模擬結果中獲得統計信息來引導後續的決策。MCTS包括四個主要步驟：選擇（Selection）、擴展（Expansion）、模擬（Simulation）和反向傳播（Backpropagation）。這些步驟以數學形式表達後，能夠為搜索過程提供理論依據，並為強化學習算法提供更為有效的決策機制。

#### 1. 選擇步驟（Selection）

選擇步驟的目標是從當前樹狀結構中的根節點出發，根據某些策略選擇下一個要擴展的節點。這一過程通常依賴於**上置信界（Upper Confidence Bound, UCB）**的策略。UCB方法平衡了探索（exploration）和利用（exploitation）之間的矛盾，通過最大化以下公式來選擇最合適的子節點：


```math
UCB_t = \hat{Q}(s_t, a_t) + C \sqrt{\frac{\ln N(s_t)}{n(s_t, a_t)}}
```


其中：
-  $`\hat{Q}(s_t, a_t)`$  是在節點  $`s_t`$  進行動作  $`a_t`$  時的平均獎勳值，表示該動作的預期回報。
-  $`N(s_t)`$  是節點  $`s_t`$  被訪問的總次數。
-  $`n(s_t, a_t)`$  是節點  $`s_t`$  上選擇動作  $`a_t`$  的次數。
-  $`C`$  是探索參數，控制探索與利用之間的平衡。這一公式使得在選擇節點時，優先考慮那些尚未充分探索過的節點（探索），同時也考慮到目前已知效果最好的動作（利用）。

#### 2. 擴展步驟（Expansion）

當選擇步驟找到一個尚未完全擴展的節點時，擴展步驟便會進行。此時，算法會根據當前節點的狀態生成一個或多個新的子節點，並將它們加入樹中。這一過程依賴於動作空間的定義以及遊戲或決策問題的具體規則。

擴展的數學背景通常與動態系統的狀態轉移有關。例如，在控制問題中，系統的狀態轉移通常由以下方程表示：


```math
s_{t+1} = f(s_t, a_t)
```


其中， $`s_t`$  是當前狀態， $`a_t`$  是當前行動， $`f`$  是系統的狀態轉移函數。這一方程描述了如何從當前狀態根據行動  $`a_t`$  轉移到下一個狀態  $`s_{t+1}`$ 。

#### 3. 模擬步驟（Simulation）

模擬步驟通過隨機選擇動作來模擬遊戲或決策過程，並最終達到遊戲的結束狀態。這一過程通常使用**隨機策略**來進行，並且在模擬的過程中不會回溯到樹的其他部分。模擬的目的是估算從當前節點開始的回報。

數學上，模擬的過程可以表達為一個隨機過程。假設有一個隨機策略  $`\pi`$  ，則模擬過程是從當前狀態  $`s_t`$  開始，根據策略  $`\pi`$  進行多步隨機選擇動作，直到達到終局狀態  $`s_T`$ ：


```math
s_0 = s_t, \quad s_{i+1} = f(s_i, \pi(s_i)) \quad \text{for} \quad i = 0, 1, 2, \dots, T-1
```


其中  $`\pi(s_i)`$  表示在狀態  $`s_i`$  下選擇的隨機動作， $`f(s_i, a_i)`$  表示狀態轉移函數，直到達到終局狀態  $`s_T`$ ，然後計算從初始狀態  $`s_t`$  到終局狀態  $`s_T`$  的回報。

#### 4. 反向傳播步驟（Backpropagation）

反向傳播步驟是將模擬結果向上傳遞，更新樹中所有涉及的節點的估算值。這個步驟的目的是將模擬過程中得到的回報（獎勳）反向傳播到所有相關節點，以便在後續的選擇步驟中能夠利用這些信息。

數學上，這一過程表示為：


```math
Q(s_t, a_t) = \frac{1}{N(s_t, a_t)} \sum_{i=1}^{N(s_t, a_t)} R_i
```


其中：
-  $`Q(s_t, a_t)`$  是在節點  $`s_t`$  上選擇動作  $`a_t`$  的累計回報。
-  $`N(s_t, a_t)`$  是節點  $`s_t`$  上選擇動作  $`a_t`$  的次數。
-  $`R_i`$  是每次模擬過程中獲得的回報。

這一公式表示對每個動作  $`a_t`$  的回報進行累計平均，並且根據模擬結果更新相應的節點評估值。

#### 5. 蒙地卡羅樹搜尋的收斂性

MCTS的核心優勢之一在於其能夠在隨著模擬次數增多的過程中收斂至一個接近最優的解。隨著模擬次數的增長，每個節點的回報估計會越來越準確。這可以用**大數法則**來理論化，該法則指出，隨著樣本數量的增加，隨機過程的平均回報將趨近於真實期望回報。

#### 6. 結論

蒙地卡羅樹搜尋（MCTS）通過結合隨機性模擬和樹形搜索策略，為處理大規模決策問題提供了一個高效的框架。其數學基礎包括了基於UCB的選擇策略、狀態轉移模型的擴展、隨機模擬的過程和反向傳播的回報更新機制。MCTS的這些數學步驟協同工作，能夠有效地探索解空間，並最終達到優化決策的目標，特別適用於強化學習、遊戲AI以及其他需要決策的領域。